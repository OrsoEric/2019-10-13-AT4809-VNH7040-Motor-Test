/****************************************************************
**	OrangeBot Project
*****************************************************************
**        /
**       /
**      /
** ______ \
**         \
**          \
*****************************************************************
**	Project
*****************************************************************
**  Brief
****************************************************************/

/****************************************************************
**	DESCRIPTION
****************************************************************
**
****************************************************************/

/****************************************************************
**	HISTORY VERSION
****************************************************************
**
****************************************************************/

/****************************************************************
**	KNOWN BUGS
****************************************************************
**
****************************************************************/

/****************************************************************
**	TODO
****************************************************************
**
****************************************************************/

/****************************************************************
**	DEFINES
****************************************************************/

#define EVER (;;)

/****************************************************************
**	INCLUDES
****************************************************************/

//Pin Configuration
//PF5: Embedded LED0

#include "global.h"

/****************************************************************
** FUNCTION PROTOTYPES
****************************************************************/

//Set direction and speed setting of the VNH7040 controlled motor
void set_vnh7040_speed( bool f_dir, uint8_t speed );

/****************************************************************
** GLOBAL VARIABLES
****************************************************************/

volatile Isr_flags g_isr_flags;

/****************************************************************************
**  Function
**  main |
****************************************************************************/
//! @return bool |
//! @brief dummy method to copy the code
//! @details test the declaration of a lambda method
/***************************************************************************/

int main(void)
{
	//----------------------------------------------------------------
	//	VARS
	//----------------------------------------------------------------

	//system tick prescaler
	uint8_t pre = 0;
		//! Motor Test
	//Speed ramp. false = accelerate | true = decelerate
	bool f_ramp = false;
	//Direction. false =  clockwise | true = counterclockwise
	bool f_dir = false;
	//Speed counter
	uint8_t speed = 0;

	//----------------------------------------------------------------
	//	INIT
	//----------------------------------------------------------------

	//! Initialize AT4809 internal peripherals
	init();
		//!	Initialize VNH7040
	//Enable sense output
	SET_BIT_VALUE( PORTF.OUT, 4, true );
	//Diagnostic mode OFF
	//SET_BIT_VALUE( PORTF.OUT, 5, false );
	
	//Set direction stop
	SET_BIT_VALUE( PORTC.OUT, 2, false );
	SET_BIT_VALUE( PORTC.OUT, 3, false );
	
	//----------------------------------------------------------------
	//	BODY
	//----------------------------------------------------------------

	//Main loop
	for EVER
	{
		//If: System Tick 500Hz
		if (g_isr_flags.system_tick == 1)
		{
			//Clear system tick
			g_isr_flags.system_tick = 0;
			
			//----------------------------------------------------------------
			//	LED BLINK
			//----------------------------------------------------------------
			
			//If prescaler has reset
			if (pre == 0)
			{
				//Toggle PF5.
				SET_BIT( PORTF.OUTTGL, 5 );	
			}
			//Increment prescaler and reset if it exceeds the TOP. 2Hz
			pre = AT_TOP_INC( pre, 249);
			
			//----------------------------------------------------------------
			//	MOTOR CONTROL
			//----------------------------------------------------------------
			
			//If increase speed
			if (f_ramp == false)
			{
				//increase speed
				speed++;
				//if: speed cap
				if (speed >= (uint8_t)0xff)
				{
					//now decrease speed
					f_ramp = true;
				}
			}
			//If decrease speed
			else
			{
				//decrease speed
				speed--;
				//If: speed cap
				if (speed <= (uint8_t)0x00)
				{
					//Now increase speed
					f_ramp = false;
					//Invert motor direction
					f_dir = !f_dir;
					//If I'm going forward again
					if (f_dir == false)
					{
						//change motor under test
						//do nothing. I have just one motor in this test.
					}
				}
			}
			//Set direction and speed setting of the VNH7040 controlled motor
			set_vnh7040_speed( f_dir, speed );
		}	//End If: System Tick
	}	//End: Main loop

	//----------------------------------------------------------------
	//	RETURN
	//----------------------------------------------------------------

	return 0;
}	//end: main

/****************************************************************************
**  Function
**  set_vnh7040_speed
****************************************************************************/
//! @return void |
//! @brief Set direction and speed setting of the VNH7040 controlled motor
//! @details 
//!
/***************************************************************************/

void set_vnh7040_speed( bool f_dir, uint8_t speed )
{
	//----------------------------------------------------------------
	//	VARS
	//----------------------------------------------------------------

	//----------------------------------------------------------------
	//	INIT
	//----------------------------------------------------------------
	
	//----------------------------------------------------------------
	//	BODY
	//----------------------------------------------------------------

	if (f_dir == true)
	{
		SET_MASKED_BIT( PORTC.OUT, 0x0c, 0x08);
	}
	else
	{
		SET_MASKED_BIT( PORTC.OUT, 0x0c, 0x04);
	}
	
	
	//Set the PWM value of the right PWM channel of TCA0
	TCA0.SPLIT.LCMP2 = speed;

	//----------------------------------------------------------------
	//	RETURN
	//----------------------------------------------------------------
	
	return;
}	//End: 
